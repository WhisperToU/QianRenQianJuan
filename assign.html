<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>布置题目（自动批次模式）</title>

    <style>
        body {
            font-family: sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .card {
            background: white;
            padding: 16px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 12px;
        }
        select, button, input {
            margin-top: 6px;
            padding: 6px 12px;
            font-size: 14px;
        }

        /* 多列学生布局 */
        .students-box {
            max-height: 300px;
            overflow-y: auto;
            padding: 8px;
            background: #fafafa;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 8px;
        }
        .student-card {
            background: #ffffff;
            border: 1px solid #d4d4d4;
            padding: 6px 10px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
        }
        .student-card input {
            transform: scale(1.2);
        }

        /* 题组行 */
        .qrow {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .btn {
            padding: 6px 14px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary { background: #2563eb; color: white; }
        .btn-secondary { background: #ddd; }
        .btn-danger { background: #dc2626; color: white; }

        pre {
            background: #222;
            color: #eee;
            padding: 10px;
            border-radius: 6px;
            white-space: pre-wrap;
        }

        .small-link {
            font-size: 12px;
            color: #2563eb;
            cursor: pointer;
            margin-top: 10px;
            display: inline-block;
        }
    </style>
</head>

<body>

<!-- 基础配置 -->
<div class="card">
    <div class="title">布置题目前端（自动批次模式）</div>
    后端地址：
    <input id="baseUrl" value="http://localhost:5000" style="width: 260px;">
</div>

<!-- 选择班级 -->
<div class="card">
    <div class="title">1. 选择班级</div>
    <select id="classSelect" style="width: 200px;">
        <option value="">加载中…</option>
    </select>
</div>

<!-- 选择学生 -->
<div class="card">
    <div class="title">2. 选择学生（多列展示 + 中文排序）</div>

    <button class="btn btn-secondary" id="btnReloadStudents">刷新学生列表</button>

    <div id="studentsBox" class="students-box" style="margin-top: 6px;">
        请选择班级
    </div>
</div>

<!-- 多题组 -->
<div class="card">
    <div class="title">3. 设置题目组（可添加多组）</div>
    <div id="questionsContainer"></div>
    <button class="btn btn-secondary" id="btnAddGroup">➕ 添加题目组</button>
</div>

<!-- 执行分配 -->
<div class="card">
    <div class="title">4. 执行分配</div>

    <label>
        <input type="checkbox" id="autoRemove" checked>
        学生分配成功后，从页面移除
    </label>

    <br><br>
    <button class="btn btn-primary" id="btnAssign">开始分配</button>

    <br><br>
    <pre id="assignResult">等待操作…</pre>
</div>

<!-- 导出 -->
<div class="card">
    <div class="title">5. 导出试卷（自动导出最新批次）</div>

    <button class="btn btn-primary" id="btnDocx">下载当前批次（最新）</button>

    <div class="small-link" id="historyLink">
        查看历史批次…
    </div>
</div>


<script>
/* 基础工具 */
function base() {
    return document.getElementById("baseUrl").value.replace(/\/+$/, "");
}

/* --------------------------
      加载班级
--------------------------- */
function loadClasses() {
    fetch(base() + "/classes/list")
        .then(r => r.json())
        .then(list => {
            const sel = document.getElementById("classSelect");
            sel.innerHTML = `<option value="">请选择班级</option>`;
            list.forEach(c => {
                sel.innerHTML += `<option value="${c.class_id}">${c.class_name}</option>`;
            });
        });
}

/* --------------------------
      加载 topic
--------------------------- */
let allTopics = [];

function loadTopics() {
    return fetch(base() + "/questions/topics")
        .then(r => r.json());
}

/* --------------------------
   加载学生（多列 + 中文排序）
--------------------------- */
let currentClassId = "";

function loadStudentsByClass(classId) {
    if (!classId) {
        document.getElementById("studentsBox").textContent = "请选择班级";
        return;
    }

    fetch(base() + "/students/by_class?class_id=" + classId)
        .then(r => r.json())
        .then(list => {
            // 中文排序
            list.sort((a, b) => a.student_name.localeCompare(b.student_name, "zh"));

            const box = document.getElementById("studentsBox");
            box.innerHTML = "";
            box.className = "students-box students-grid";

            list.forEach(stu => {
                const div = document.createElement("div");
                div.className = "student-card";
                div.innerHTML = `
                    <input type="checkbox" class="stu-checkbox" value="${stu.student_id}">
                    <span>${stu.student_name}</span>
                `;
                box.appendChild(div);
            });
        });
}

document.getElementById("classSelect").onchange = function () {
    currentClassId = this.value;
    loadStudentsByClass(currentClassId);
};

document.getElementById("btnReloadStudents").onclick = function () {
    if (!currentClassId) {
        alert("请先选择班级");
        return;
    }
    loadStudentsByClass(currentClassId);
};


/* --------------------------
   添加题目组
--------------------------- */
function addQuestionGroup() {
    const container = document.getElementById("questionsContainer");

    const div = document.createElement("div");
    div.className = "qrow";

    div.innerHTML = `
        <select class="topic" style="min-width:160px;"></select>
        <select class="difficulty">
            <option value="easy">easy</option>
            <option value="medium">medium</option>
        </select>
        <button class="btn btn-danger btnRemove">删除</button>
    `;

    div.querySelector(".btnRemove").onclick = () => div.remove();

    container.appendChild(div);

    const topicSelect = div.querySelector(".topic");
    allTopics.forEach(t => {
        topicSelect.innerHTML += `<option value="${t}">${t}</option>`;
    });
}

document.getElementById("btnAddGroup").onclick = addQuestionGroup;


/* --------------------------
     分配题目（自动批次）
--------------------------- */
document.getElementById("btnAssign").onclick = async function () {
    const selected = Array.from(document.querySelectorAll(".stu-checkbox:checked"))
        .map(cb => Number(cb.value));

    if (selected.length === 0) {
        alert("请至少选择一个学生！");
        return;
    }

    const groups = Array.from(document.querySelectorAll("#questionsContainer .qrow"))
        .map(row => ({
            topic: row.querySelector(".topic").value,
            difficulty: row.querySelector(".difficulty").value
        }));

    if (groups.length === 0) {
        alert("请至少添加一个题目组！");
        return;
    }

    const autoRemove = document.getElementById("autoRemove").checked;

    let log = "";
    let allSuccess = true;

    for (let g of groups) {
        const payload = {
            student_ids: selected,
            topic: g.topic,
            difficulty_level: g.difficulty
            // 不需要 new_session，后端会自动批次管理
        };

        log += `发送: ${JSON.stringify(payload)}\n`;

        try {
            const res = await fetch(base() + "/assign/one", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(payload)
            });

            const text = await res.text();
            let data;
            try { data = JSON.parse(text); } 
            catch { data = text; }

            if (!(res.status >= 200 && res.status < 300)) {
                allSuccess = false;
            }

            log += `返回 HTTP ${res.status}:\n${JSON.stringify(data, null, 2)}\n\n`;
        }
        catch (err) {
            allSuccess = false;
            log += `请求异常: ${err}\n\n`;
        }
    }

    if (allSuccess && autoRemove) {
        removeAssignedStudents(selected);
        log += "全部题组分配成功，已从页面移除这些学生。\n";
    }

    document.getElementById("assignResult").textContent = log;
};

function removeAssignedStudents(ids) {
    ids.forEach(id => {
        const cb = document.querySelector(`.stu-checkbox[value='${id}']`);
        if (cb) cb.closest(".student-card").remove();
    });
}

/* --------------------------
       下载当前批次
--------------------------- */
document.getElementById("btnDocx").onclick = function () {
    window.open(base() + "/assign/final_docx?session_id=latest");
};

/* --------------------------
       历史批次入口
--------------------------- */
document.getElementById("historyLink").onclick = function () {
    window.location.href = "/assign/sessions.html";  
};

/* 初始化 */
loadClasses();
loadTopics().then(t => {
    allTopics = t;
    addQuestionGroup();
});
</script>

</body>
</html>
